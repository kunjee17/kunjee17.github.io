---
interface Props {
	id: string;
	name: string;
	value?: string;
	placeholder?: string;
	required?: boolean;
	class?: string;
}

const {
	id,
	name,
	value = "",
	placeholder = "Start typing markdown...",
	required = false,
	class: className = "",
}: Props = Astro.props;
---

<div class={`markdown-editor-wrapper ${className}`}>
	<textarea
		id={id}
		name={name}
		placeholder={placeholder}
		required={required}
		class="hidden"
		value={value}
	></textarea>
	<div id={`${id}-editor`} data-editor-id={id} data-initial-value={value}></div>
</div>

<script>
	// Global storage for crepe instances
	let crepeInstances = new Map();

	function initEditors() {
		document.querySelectorAll("[data-editor-id]").forEach((editorDiv) => {
			const editorId = editorDiv.getAttribute("data-editor-id");
			if (!editorId) return;

			// Skip if already initialized
			if (crepeInstances.has(editorId)) return;

			const initialValue = editorDiv.getAttribute("data-initial-value") || "";
			const editorElementId = `${editorId}-editor`;

			(async () => {
				try {
					const { Crepe } = await import("@milkdown/crepe");
					await import("@milkdown/crepe/theme/common/style.css");
					await import("@milkdown/crepe/theme/frame.css");

					const textarea = document.getElementById(editorId);
					const editorElement = document.getElementById(editorElementId);

					if (!editorElement || !textarea || !(textarea instanceof HTMLTextAreaElement)) return;

					const crepe = new Crepe({
						root: `#${editorElementId}`,
						defaultValue: initialValue || textarea.value || "",
					});

					await crepe.create();

					// Store crepe instance
					crepeInstances.set(editorId, crepe);

					// Sync on form submit
					const form = textarea.closest("form");
					if (form) {
						// Also intercept submit button clicks as backup
						const submitButton = form.querySelector('button[type="submit"]');
						if (submitButton) {
							submitButton.addEventListener("click", (e) => {
								const crepeInstance = crepeInstances.get(editorId);
								if (crepeInstance) {
									textarea.value = crepeInstance.getMarkdown();
								}
							});
						}

						// Main submit handler
						form.addEventListener("submit", () => {
							const crepeInstance = crepeInstances.get(editorId);
							if (crepeInstance) {
								textarea.value = crepeInstance.getMarkdown();
							}
						}, true);
					}
				} catch (error) {
					console.error("Error initializing Milkdown editor:", error);
				}
			})();
		});
	}

	if (typeof window !== "undefined") {
		if (document.readyState === "loading") {
			document.addEventListener("DOMContentLoaded", initEditors);
		} else {
			initEditors();
		}
	}
</script>

<style>
	.markdown-editor-wrapper {
		width: 100%;
	}

	.markdown-editor-wrapper .milkdown {
		outline: none;
		min-height: 400px;
	}

	/* Ensure prose styles work well */
	.markdown-editor-wrapper .prose {
		max-width: 100%;
	}
</style>
