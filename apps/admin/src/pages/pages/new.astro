---
import {
	checkPageSlugExists,
	createPage,
	generateSlug,
	validateSlugFormat,
} from "../../lib/db";

// Handle form submission
if (Astro.request.method === "POST") {
	const formData = await Astro.request.formData();

	const title = (formData.get("title")?.toString() || "").trim();
	const slugInput = formData.get("slug")?.toString()?.trim();
	const slug = slugInput || generateSlug(title);
	const linkTitle = formData.get("linkTitle")?.toString()?.trim();
	const description = formData.get("description")?.toString()?.trim();
	const summary = formData.get("summary")?.toString()?.trim();
	const content = (formData.get("content")?.toString() || "").trim();

	// Validation
	if (!title) {
		return Astro.redirect("/pages/new?error=title_required", 302);
	}

	if (!content) {
		return Astro.redirect("/pages/new?error=content_required", 302);
	}

	if (!validateSlugFormat(slug)) {
		return Astro.redirect("/pages/new?error=invalid_slug", 302);
	}

	// Validate URL format if provided
	const url = formData.get("url")?.toString()?.trim();
	if (url && !isValidUrlPath(url)) {
		return Astro.redirect("/pages/new?error=invalid_url", 302);
	}

	// Validate dates
	const publishedAtStr = formData.get("publishedAt")?.toString();
	const expiryDateStr = formData.get("expiryDate")?.toString();
	let publishedAt: Date | undefined;
	let expiryDate: Date | undefined;

	if (publishedAtStr) {
		publishedAt = new Date(publishedAtStr);
		if (Number.isNaN(publishedAt.getTime())) {
			return Astro.redirect("/pages/new?error=invalid_published_date", 302);
		}
	}

	if (expiryDateStr) {
		expiryDate = new Date(expiryDateStr);
		if (Number.isNaN(expiryDate.getTime())) {
			return Astro.redirect("/pages/new?error=invalid_expiry_date", 302);
		}
	}

	const draft = formData.get("draft") === "on";

	const keywordsStr = formData.get("keywords")?.toString();
	const keywords = keywordsStr
		? keywordsStr
				.split(",")
				.map((k) => k.trim())
				.filter((k) => k.length > 0)
		: undefined;

	const aliasesStr = formData.get("aliases")?.toString();
	const aliases = aliasesStr
		? aliasesStr
				.split(",")
				.map((a) => a.trim())
				.filter((a) => a.length > 0)
		: undefined;

	const type = formData.get("type")?.toString()?.trim();
	const layout = formData.get("layout")?.toString()?.trim();
	const weightStr = formData.get("weight")?.toString();

	try {
		// Check for duplicate slug
		if (await checkPageSlugExists(slug)) {
			return Astro.redirect("/pages/new?error=slug_exists", 302);
		}

		const pageId = await createPage({
			title,
			slug,
			linkTitle,
			description,
			summary,
			content,
			publishedAt,
			expiryDate,
			draft,
			keywords,
			aliases,
			url,
			type,
			layout,
			weight: weightStr ? parseInt(weightStr, 10) : undefined,
		});

		return Astro.redirect(`/pages/${pageId}?created=true`, 302);
	} catch (error) {
		console.error("Error creating page:", error);
		// Check if it's a database constraint error
		if (error instanceof Error && error.message.includes("UNIQUE")) {
			if (error.message.includes("slug")) {
				return Astro.redirect("/pages/new?error=slug_exists", 302);
			}
		}
		return Astro.redirect("/pages/new?error=create_failed", 302);
	}
}

// Helper function to validate URL path format
function isValidUrlPath(path: string): boolean {
	// URL path should start with / and be a valid path
	return /^\/[^\s]*$/.test(path);
}

const _error = Astro.url.searchParams.get("error");
const _errorMessages: Record<string, string> = {
	title_required: "Page title is required.",
	content_required: "Page content is required.",
	slug_exists: "A page with this slug already exists.",
	invalid_slug:
		"Slug format is invalid. Use only lowercase letters, numbers, and hyphens.",
	invalid_url: "Invalid URL format. URL must start with / and be a valid path.",
	invalid_published_date: "Invalid published date format.",
	invalid_expiry_date: "Invalid expiry date format.",
	create_failed: "Error creating page. Please try again.",
};
---

<AdminLayout title="New Page">
	<div class="space-y-6">
		<h1 class="text-3xl font-bold">New Page</h1>

		{error && (
			<div class="alert alert-error">
				<span>{errorMessages[error] || "Error creating page. Please try again."}</span>
			</div>
		)}

		<form method="POST" class="space-y-6">
			<div class="card bg-base-100 shadow">
				<div class="card-body">
					<h2 class="card-title">Basic Information</h2>
					<div class="space-y-4">
						<div class="form-control">
							<label class="label" for="title">
								<span class="label-text">Title *</span>
							</label>
							<input
								type="text"
								id="title"
								name="title"
								placeholder="Page title"
								class="input input-bordered w-full"
								required
							/>
						</div>

						<div class="form-control">
							<label class="label" for="slug">
								<span class="label-text">Slug</span>
								<span class="label-text-alt">Auto-generated from title if empty</span>
							</label>
							<input
								type="text"
								id="slug"
								name="slug"
								placeholder="page-slug"
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="linkTitle">
								<span class="label-text">Link Title</span>
							</label>
							<input
								type="text"
								id="linkTitle"
								name="linkTitle"
								placeholder="Short title"
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="description">
								<span class="label-text">Description</span>
							</label>
							<textarea
								id="description"
								name="description"
								placeholder="SEO meta description"
								class="textarea textarea-bordered w-full"
								rows="2"
							></textarea>
						</div>

						<div class="form-control">
							<label class="label" for="summary">
								<span class="label-text">Summary</span>
							</label>
							<textarea
								id="summary"
								name="summary"
								placeholder="Content summary"
								class="textarea textarea-bordered w-full"
								rows="3"
							></textarea>
						</div>

						<div class="form-control">
							<label class="label" for="content">
								<span class="label-text">Content *</span>
								<span class="label-text-alt">WYSIWYG Markdown Editor</span>
							</label>
							<MarkdownEditor
								id="content"
								name="content"
								placeholder="Start typing your markdown content..."
								required={true}
							/>
						</div>
					</div>
				</div>
			</div>

			<div class="card bg-base-100 shadow">
				<div class="card-body">
					<h2 class="card-title">Status & Dates</h2>
					<div class="space-y-4">
						<div class="form-control">
							<label class="label cursor-pointer">
								<span class="label-text">Draft</span>
								<input
									type="checkbox"
									name="draft"
									class="checkbox checkbox-primary"
									checked
								/>
							</label>
						</div>

						<div class="form-control">
							<label class="label" for="publishedAt">
								<span class="label-text">Published Date</span>
							</label>
							<input
								type="datetime-local"
								id="publishedAt"
								name="publishedAt"
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="expiryDate">
								<span class="label-text">Expiry Date</span>
							</label>
							<input
								type="datetime-local"
								id="expiryDate"
								name="expiryDate"
								class="input input-bordered w-full"
							/>
						</div>
					</div>
				</div>
			</div>

			<div class="card bg-base-100 shadow">
				<div class="card-body">
					<h2 class="card-title">SEO</h2>
					<div class="space-y-4">
						<div class="form-control">
							<label class="label" for="keywords">
								<span class="label-text">Keywords</span>
							</label>
							<input
								type="text"
								id="keywords"
								name="keywords"
								placeholder="keyword1, keyword2"
								class="input input-bordered w-full"
							/>
						</div>
					</div>
				</div>
			</div>

			<div class="card bg-base-100 shadow">
				<div class="card-body">
					<h2 class="card-title">URL Management</h2>
					<div class="space-y-4">
						<div class="form-control">
							<label class="label" for="url">
								<span class="label-text">Custom URL Override</span>
							</label>
							<input
								type="text"
								id="url"
								name="url"
								placeholder="/custom/url"
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="aliases">
								<span class="label-text">Aliases</span>
							</label>
							<input
								type="text"
								id="aliases"
								name="aliases"
								placeholder="/old-url1, /old-url2"
								class="input input-bordered w-full"
							/>
						</div>
					</div>
				</div>
			</div>

			<div class="card bg-base-100 shadow">
				<div class="card-body">
					<h2 class="card-title">Template Selection</h2>
					<div class="space-y-4">
						<div class="form-control">
							<label class="label" for="type">
								<span class="label-text">Type</span>
							</label>
							<input
								type="text"
								id="type"
								name="type"
								placeholder="page"
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="layout">
								<span class="label-text">Layout</span>
							</label>
							<input
								type="text"
								id="layout"
								name="layout"
								placeholder="page"
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="weight">
								<span class="label-text">Weight</span>
							</label>
							<input
								type="number"
								id="weight"
								name="weight"
								class="input input-bordered w-full"
								placeholder="0"
							/>
						</div>
					</div>
				</div>
			</div>

			<div class="card-actions justify-end">
				<a href="/pages" class="btn btn-ghost">
					<Cancel class="size-5" />
					Cancel
				</a>
				<button type="submit" class="btn btn-primary">
					<Save class="size-5" />
					Save Page
				</button>
			</div>
		</form>
	</div>
</AdminLayout>

<script>
	// Auto-generate slug from title
	function generateSlug(text: string): string {
		return text
			.toLowerCase()
			.trim()
			.replace(/[^\w\s-]/g, "")
			.replace(/[\s_-]+/g, "-")
			.replace(/^-+|-+$/g, "");
	}

	const titleInput = document.getElementById("title") as HTMLInputElement;
	const slugInput = document.getElementById("slug") as HTMLInputElement;
	let lastAutoGeneratedSlug = "";

	if (titleInput && slugInput) {
		// Store initial slug value to detect manual edits
		let slugManuallyEdited = false;
		const originalSlug = slugInput.value;

		titleInput.addEventListener("input", () => {
			if (!slugManuallyEdited) {
				const autoSlug = generateSlug(titleInput.value);
				slugInput.value = autoSlug;
				lastAutoGeneratedSlug = autoSlug;
			}
		});

		slugInput.addEventListener("input", () => {
			// Check if user manually edited the slug
			const currentSlug = slugInput.value;
			if (currentSlug !== lastAutoGeneratedSlug && currentSlug !== originalSlug) {
				slugManuallyEdited = true;
			} else if (currentSlug === "" || currentSlug === generateSlug(titleInput.value)) {
				// Reset if cleared or matches auto-generated value
				slugManuallyEdited = false;
			}
		});
	}
</script>
