---
import AdminLayout from "../../components/layout/AdminLayout.astro";
import { Save, X as Cancel } from "@lucide/astro";
import MarkdownEditor from "../../components/ui/MarkdownEditor.astro";
import { getPage, updatePage, generateSlug, validateSlugFormat, checkPageSlugExists } from "../../lib/db";
import { format } from "date-fns";

const { id } = Astro.params;

const page = await getPage(id || "");

if (!page) {
	return Astro.redirect("/pages?error=not_found", 302);
}

// Handle form submission
if (Astro.request.method === "POST") {
	const formData = await Astro.request.formData();

	const title = (formData.get("title")?.toString() || "").trim();
	const slug = (formData.get("slug")?.toString() || "").trim() || generateSlug(title);
	const linkTitle = formData.get("linkTitle")?.toString()?.trim();
	const description = formData.get("description")?.toString()?.trim();
	const summary = formData.get("summary")?.toString()?.trim();
	const content = (formData.get("content")?.toString() || "").trim();

	// Validation
	if (!title) {
		return Astro.redirect(`/pages/${id}?error=title_required`, 302);
	}

	if (!content) {
		return Astro.redirect(`/pages/${id}?error=content_required`, 302);
	}

	if (!validateSlugFormat(slug)) {
		return Astro.redirect(`/pages/${id}?error=invalid_slug`, 302);
	}

	// Validate URL format if provided
	const url = formData.get("url")?.toString()?.trim();
	if (url && !isValidUrlPath(url)) {
		return Astro.redirect(`/pages/${id}?error=invalid_url`, 302);
	}

	// Validate dates
	const publishedAtStr = formData.get("publishedAt")?.toString();
	const expiryDateStr = formData.get("expiryDate")?.toString();
	let publishedAt: Date | undefined;
	let expiryDate: Date | undefined;

	if (publishedAtStr) {
		publishedAt = new Date(publishedAtStr);
		if (isNaN(publishedAt.getTime())) {
			return Astro.redirect(`/pages/${id}?error=invalid_published_date`, 302);
		}
	}

	if (expiryDateStr) {
		expiryDate = new Date(expiryDateStr);
		if (isNaN(expiryDate.getTime())) {
			return Astro.redirect(`/pages/${id}?error=invalid_expiry_date`, 302);
		}
	}

	const draft = formData.get("draft") === "on";

	const keywordsStr = formData.get("keywords")?.toString();
	const keywords = keywordsStr
		? keywordsStr.split(",").map((k) => k.trim()).filter((k) => k.length > 0)
		: undefined;

	const aliasesStr = formData.get("aliases")?.toString();
	const aliases = aliasesStr
		? aliasesStr.split(",").map((a) => a.trim()).filter((a) => a.length > 0)
		: undefined;

	const type = formData.get("type")?.toString()?.trim();
	const layout = formData.get("layout")?.toString()?.trim();
	const weightStr = formData.get("weight")?.toString();

	try {
		// Check for duplicate slug (if slug changed)
		if (slug !== page.slug && (await checkPageSlugExists(slug, id))) {
			return Astro.redirect(`/pages/${id}?error=slug_exists`, 302);
		}

		await updatePage(id!, {
			title,
			slug,
			linkTitle,
			description,
			summary,
			content,
			publishedAt,
			expiryDate,
			draft,
			keywords,
			aliases,
			url,
			type,
			layout,
			weight: weightStr ? parseInt(weightStr, 10) : undefined,
		});

		return Astro.redirect(`/pages/${id}?updated=true`, 302);
	} catch (error) {
		console.error("Error updating page:", error);
		// Check if it's a database constraint error
		if (error instanceof Error && error.message.includes("UNIQUE")) {
			if (error.message.includes("slug")) {
				return Astro.redirect(`/pages/${id}?error=slug_exists`, 302);
			}
		}
		return Astro.redirect(`/pages/${id}?error=update_failed`, 302);
	}
}

// Helper function to validate URL path format
function isValidUrlPath(path: string): boolean {
	// URL path should start with / and be a valid path
	return /^\/[^\s]*$/.test(path);
}

function formatDateTimeLocal(date: Date | null | undefined): string {
	if (!date) return "";
	const d = new Date(date);
	d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
	return d.toISOString().slice(0, 16);
}

const updated = Astro.url.searchParams.get("updated") === "true";
const error = Astro.url.searchParams.get("error");
const created = Astro.url.searchParams.get("created") === "true";
const errorMessages: Record<string, string> = {
	title_required: "Page title is required.",
	content_required: "Page content is required.",
	slug_exists: "A page with this slug already exists.",
	invalid_slug: "Slug format is invalid. Use only lowercase letters, numbers, and hyphens.",
	invalid_url: "Invalid URL format. URL must start with / and be a valid path.",
	invalid_published_date: "Invalid published date format.",
	invalid_expiry_date: "Invalid expiry date format.",
	update_failed: "Failed to update page. Please try again.",
};

const keywords = page.keywords ? (typeof page.keywords === "string" ? JSON.parse(page.keywords) : page.keywords) : [];
const aliases = page.aliases ? (typeof page.aliases === "string" ? JSON.parse(page.aliases) : page.aliases) : [];
---

<AdminLayout title={`Edit Page - ${page.title}`}>
	<div class="space-y-6">
		<h1 class="text-3xl font-bold">Edit Page</h1>

		{created && <div class="alert alert-success"><span>Page created successfully!</span></div>}
		{updated && <div class="alert alert-success"><span>Page updated successfully!</span></div>}
		{error && (
			<div class="alert alert-error">
				<span>{errorMessages[error] || `Error: ${error}`}</span>
			</div>
		)}

		<form method="POST" class="space-y-6">
			<div class="card bg-base-100 shadow">
				<div class="card-body">
					<h2 class="card-title">Basic Information</h2>
					<div class="space-y-4">
						<div class="form-control">
							<label class="label" for="title">
								<span class="label-text">Title *</span>
							</label>
							<input
								type="text"
								id="title"
								name="title"
								value={page.title}
								class="input input-bordered w-full"
								required
							/>
						</div>

						<div class="form-control">
							<label class="label" for="slug">
								<span class="label-text">Slug</span>
							</label>
							<input
								type="text"
								id="slug"
								name="slug"
								value={page.slug}
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="linkTitle">
								<span class="label-text">Link Title</span>
							</label>
							<input
								type="text"
								id="linkTitle"
								name="linkTitle"
								value={page.linkTitle || ""}
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="description">
								<span class="label-text">Description</span>
							</label>
							<textarea
								id="description"
								name="description"
								class="textarea textarea-bordered w-full"
								rows="2"
							>{page.description || ""}</textarea>
						</div>

						<div class="form-control">
							<label class="label" for="summary">
								<span class="label-text">Summary</span>
							</label>
							<textarea
								id="summary"
								name="summary"
								class="textarea textarea-bordered w-full"
								rows="3"
							>{page.summary || ""}</textarea>
						</div>

						<div class="form-control">
							<label class="label" for="content">
								<span class="label-text">Content *</span>
								<span class="label-text-alt">WYSIWYG Markdown Editor</span>
							</label>
							<MarkdownEditor
								id="content"
								name="content"
								value={page.content}
								required={true}
							/>
						</div>
					</div>
				</div>
			</div>

			<div class="card bg-base-100 shadow">
				<div class="card-body">
					<h2 class="card-title">Status & Dates</h2>
					<div class="space-y-4">
						<div class="form-control">
							<label class="label cursor-pointer">
								<span class="label-text">Draft</span>
								<input
									type="checkbox"
									name="draft"
									class="checkbox checkbox-primary"
									checked={page.draft}
								/>
							</label>
						</div>

						<div class="form-control">
							<label class="label" for="publishedAt">
								<span class="label-text">Published Date</span>
							</label>
							<input
								type="datetime-local"
								id="publishedAt"
								name="publishedAt"
								value={formatDateTimeLocal(page.publishedAt)}
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="expiryDate">
								<span class="label-text">Expiry Date</span>
							</label>
							<input
								type="datetime-local"
								id="expiryDate"
								name="expiryDate"
								value={formatDateTimeLocal(page.expiryDate)}
								class="input input-bordered w-full"
							/>
						</div>

						<div class="text-sm text-base-content/60">
							<div>Created: {format(new Date(page.createdAt), "PPpp")}</div>
							<div>Updated: {format(new Date(page.updatedAt), "PPpp")}</div>
						</div>
					</div>
				</div>
			</div>

			<div class="card bg-base-100 shadow">
				<div class="card-body">
					<h2 class="card-title">SEO</h2>
					<div class="space-y-4">
						<div class="form-control">
							<label class="label" for="keywords">
								<span class="label-text">Keywords</span>
							</label>
							<input
								type="text"
								id="keywords"
								name="keywords"
								value={Array.isArray(keywords) ? keywords.join(", ") : ""}
								class="input input-bordered w-full"
							/>
						</div>
					</div>
				</div>
			</div>

			<div class="card bg-base-100 shadow">
				<div class="card-body">
					<h2 class="card-title">URL Management</h2>
					<div class="space-y-4">
						<div class="form-control">
							<label class="label" for="url">
								<span class="label-text">Custom URL Override</span>
							</label>
							<input
								type="text"
								id="url"
								name="url"
								value={page.url || ""}
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="aliases">
								<span class="label-text">Aliases</span>
							</label>
							<input
								type="text"
								id="aliases"
								name="aliases"
								value={Array.isArray(aliases) ? aliases.join(", ") : ""}
								class="input input-bordered w-full"
							/>
						</div>
					</div>
				</div>
			</div>

			<div class="card bg-base-100 shadow">
				<div class="card-body">
					<h2 class="card-title">Template Selection</h2>
					<div class="space-y-4">
						<div class="form-control">
							<label class="label" for="type">
								<span class="label-text">Type</span>
							</label>
							<input
								type="text"
								id="type"
								name="type"
								value={page.type || ""}
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="layout">
								<span class="label-text">Layout</span>
							</label>
							<input
								type="text"
								id="layout"
								name="layout"
								value={page.layout || ""}
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="weight">
								<span class="label-text">Weight</span>
							</label>
							<input
								type="number"
								id="weight"
								name="weight"
								value={page.weight || ""}
								class="input input-bordered w-full"
							/>
						</div>
					</div>
				</div>
			</div>

			<div class="card-actions justify-end">
				<a href="/pages" class="btn btn-ghost">
					<Cancel class="size-5" />
					Cancel
				</a>
				<button type="submit" class="btn btn-primary">
					<Save class="size-5" />
					Update Page
				</button>
			</div>
		</form>
	</div>
</AdminLayout>

<script>
	// Auto-generate slug from title
	function generateSlug(text: string): string {
		return text
			.toLowerCase()
			.trim()
			.replace(/[^\w\s-]/g, "")
			.replace(/[\s_-]+/g, "-")
			.replace(/^-+|-+$/g, "");
	}

	const titleInput = document.getElementById("title") as HTMLInputElement;
	const slugInput = document.getElementById("slug") as HTMLInputElement;

	if (titleInput && slugInput) {
		// Store initial slug value to detect manual edits
		let slugManuallyEdited = false;
		const originalSlug = slugInput.value;
		let lastAutoGeneratedSlug = originalSlug;

		titleInput.addEventListener("input", () => {
			if (!slugManuallyEdited) {
				const autoSlug = generateSlug(titleInput.value);
				slugInput.value = autoSlug;
				lastAutoGeneratedSlug = autoSlug;
			}
		});

		slugInput.addEventListener("input", () => {
			// Check if user manually edited the slug
			const currentSlug = slugInput.value;
			if (currentSlug !== lastAutoGeneratedSlug && currentSlug !== originalSlug) {
				slugManuallyEdited = true;
			} else if (currentSlug === "" || currentSlug === generateSlug(titleInput.value)) {
				// Reset if cleared or matches auto-generated value
				slugManuallyEdited = false;
			}
		});
	}
</script>
