---
import { createMedia } from "../../lib/db";

if (Astro.request.method === "POST") {
	const formData = await Astro.request.formData();
	const filename = formData.get("filename")?.toString() || "";
	const url = formData.get("url")?.toString() || "";
	const storageProvider =
		formData.get("storageProvider")?.toString() || "local";
	const mimeType = formData.get("mimeType")?.toString();
	const sizeStr = formData.get("size")?.toString();
	const altText = formData.get("altText")?.toString();
	const title = formData.get("title")?.toString();
	const caption = formData.get("caption")?.toString();
	const widthStr = formData.get("width")?.toString();
	const heightStr = formData.get("height")?.toString();

	try {
		await createMedia({
			filename,
			url,
			storageProvider,
			mimeType,
			size: sizeStr ? parseInt(sizeStr, 10) : undefined,
			altText,
			title,
			caption,
			width: widthStr ? parseInt(widthStr, 10) : undefined,
			height: heightStr ? parseInt(heightStr, 10) : undefined,
		});
		return Astro.redirect("/media?created=true", 302);
	} catch (error) {
		console.error("Error creating media:", error);
		return Astro.redirect("/media/new?error=create_failed", 302);
	}
}

const _error = Astro.url.searchParams.get("error");
---

<AdminLayout title="Upload Media">
	<div class="space-y-6">
		<h1 class="text-3xl font-bold">Upload Media</h1>

		{error && (
			<div class="alert alert-error">
				<span>Error uploading media. Please try again.</span>
			</div>
		)}

		<form method="POST" class="card bg-base-100 shadow">
			<div class="card-body space-y-4">
				<div class="form-control">
					<label class="label" for="filename">
						<span class="label-text">Filename *</span>
					</label>
					<input
						type="text"
						id="filename"
						name="filename"
						placeholder="image.jpg"
						class="input input-bordered w-full"
						required
					/>
				</div>

				<div class="form-control">
					<label class="label" for="url">
						<span class="label-text">URL *</span>
					</label>
					<input
						type="url"
						id="url"
						name="url"
						placeholder="https://example.com/image.jpg"
						class="input input-bordered w-full"
						required
					/>
				</div>

				<div class="form-control">
					<label class="label" for="storageProvider">
						<span class="label-text">Storage Provider *</span>
					</label>
					<select id="storageProvider" name="storageProvider" class="select select-bordered w-full" required>
						<option value="local" selected>Local</option>
						<option value="s3">S3</option>
						<option value="cloudinary">Cloudinary</option>
						<option value="other">Other</option>
					</select>
				</div>

				<div class="form-control">
					<label class="label" for="mimeType">
						<span class="label-text">MIME Type</span>
					</label>
					<input
						type="text"
						id="mimeType"
						name="mimeType"
						placeholder="image/jpeg"
						class="input input-bordered w-full"
					/>
				</div>

				<div class="form-control">
					<label class="label" for="size">
						<span class="label-text">Size (bytes)</span>
					</label>
					<input
						type="number"
						id="size"
						name="size"
						placeholder="102400"
						class="input input-bordered w-full"
					/>
				</div>

				<div class="divider">SEO Fields</div>

				<div class="form-control">
					<label class="label" for="altText">
						<span class="label-text">Alt Text</span>
					</label>
					<input
						type="text"
						id="altText"
						name="altText"
						placeholder="Descriptive alt text"
						class="input input-bordered w-full"
					/>
				</div>

				<div class="form-control">
					<label class="label" for="title">
						<span class="label-text">Title</span>
					</label>
					<input
						type="text"
						id="title"
						name="title"
						placeholder="Image title"
						class="input input-bordered w-full"
					/>
				</div>

				<div class="form-control">
					<label class="label" for="caption">
						<span class="label-text">Caption</span>
					</label>
					<textarea
						id="caption"
						name="caption"
						placeholder="Image caption"
						class="textarea textarea-bordered w-full"
						rows="2"
					></textarea>
				</div>

				<div class="form-control">
					<label class="label" for="width">
						<span class="label-text">Width (px)</span>
					</label>
					<input
						type="number"
						id="width"
						name="width"
						placeholder="1920"
						class="input input-bordered w-full"
					/>
				</div>

				<div class="form-control">
					<label class="label" for="height">
						<span class="label-text">Height (px)</span>
					</label>
					<input
						type="number"
						id="height"
						name="height"
						placeholder="1080"
						class="input input-bordered w-full"
					/>
				</div>

				<div class="card-actions justify-end">
					<a href="/media" class="btn btn-ghost">
						<Cancel class="size-5" />
						Cancel
					</a>
					<button type="submit" class="btn btn-primary">
						<Save class="size-5" />
						Save Media
					</button>
				</div>
			</div>
		</form>
	</div>
</AdminLayout>
