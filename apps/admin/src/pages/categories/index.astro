---
import AdminLayout from "@components/layout/AdminLayout.astro";
import { Edit, Plus, Trash2, Upload } from "@lucide/astro";
import {
	checkCategoryNameExists,
	checkCategorySlugExists,
	createCategory,
	deleteCategory,
	generateSlug,
	getCategoriesWithWritingCounts,
} from "../../lib/queries";

// Handle POST actions (delete and bulk_create)
if (Astro.request.method === "POST") {
	const formData = await Astro.request.formData();
	const action = formData.get("action");
	const categoryId = formData.get("categoryId")?.toString();

	if (action === "delete" && categoryId) {
		try {
			await deleteCategory(categoryId);
			return Astro.redirect("/categories?deleted=true", 302);
		} catch (error) {
			console.error("Error deleting category:", error);
			return Astro.redirect("/categories?error=delete_failed", 302);
		}
	}

	if (action === "bulk_create") {
		const categoriesInput = formData.get("categories")?.toString() || "";

		if (!categoriesInput.trim()) {
			return Astro.redirect("/categories?error=bulk_empty", 302);
		}

		// Parse comma-separated categories
		const categoryNames = categoriesInput
			.split(",")
			.map((name) => name.trim())
			.filter((name) => name.length > 0);

		if (categoryNames.length === 0) {
			return Astro.redirect("/categories?error=bulk_empty", 302);
		}

		let createdCount = 0;
		let skippedCount = 0;
		const errors: string[] = [];

		for (const categoryName of categoryNames) {
			try {
				// Check if category already exists
				const nameExists = await checkCategoryNameExists(categoryName);
				const slug = generateSlug(categoryName);
				const slugExists = await checkCategorySlugExists(slug);

				if (nameExists || slugExists) {
					skippedCount++;
					continue;
				}

				// Create category with defaults (auto-generated slug, no description)
				await createCategory({
					name: categoryName,
					slug: slug,
					description: undefined,
				});
				createdCount++;
			} catch (error) {
				console.error(`Error creating category "${categoryName}":`, error);
				errors.push(categoryName);
			}
		}

		// Build redirect URL with results
		const params = new URLSearchParams();
		if (createdCount > 0) {
			params.set("bulk_created", createdCount.toString());
		}
		if (skippedCount > 0) {
			params.set("bulk_skipped", skippedCount.toString());
		}
		if (errors.length > 0) {
			params.set("bulk_errors", errors.length.toString());
		}

		return Astro.redirect(`/categories?${params.toString()}`, 302);
	}
}

const categoriesWithCounts = await getCategoriesWithWritingCounts();

const deleted = Astro.url.searchParams.get("deleted") === "true";
const created = Astro.url.searchParams.get("created") === "true";
const error = Astro.url.searchParams.get("error");
const bulkCreated = Astro.url.searchParams.get("bulk_created");
const bulkSkipped = Astro.url.searchParams.get("bulk_skipped");
const bulkErrors = Astro.url.searchParams.get("bulk_errors");
---

<AdminLayout title="Categories">
	<div class="space-y-6">
		<div class="flex items-center justify-between">
			<h1 class="text-3xl font-bold">Categories</h1>
			<a href="/categories/new" class="btn btn-primary">
				<Plus class="size-5" />
				New Category
			</a>
		</div>

		{deleted && (
			<div class="alert alert-success">
				<span>Category deleted successfully.</span>
			</div>
		)}

		{created && (
			<div class="alert alert-success">
				<span>Category created successfully.</span>
			</div>
		)}

		{error && (
			<div class="alert alert-error">
				<span>
					Error:{" "}
					{error === "delete_failed"
						? "Failed to delete category"
						: error === "bulk_empty"
							? "Please enter at least one category name"
							: error}
				</span>
			</div>
		)}

		{bulkCreated && (
			<div class="alert alert-success">
				<span>
					Successfully created {bulkCreated} categor{bulkCreated !== "1" ? "ies" : "y"}.
					{bulkSkipped &&
						` ${bulkSkipped} categor${bulkSkipped !== "1" ? "ies" : "y"} skipped (already exist).`}
					{bulkErrors &&
						` ${bulkErrors} categor${bulkErrors !== "1" ? "ies" : "y"} failed to create.`}
				</span>
			</div>
		)}

		<!-- Bulk Upload Section -->
		<div class="card bg-base-100 shadow">
			<div class="card-body">
				<div class="flex items-center justify-between mb-4">
					<h2 class="text-xl font-semibold">Bulk Upload Categories</h2>
					<button
						type="button"
						class="btn btn-sm btn-ghost"
						id="toggle-bulk-upload"
						onclick="toggleBulkUpload()"
					>
						<Upload class="size-4" />
						<span id="toggle-text">Hide</span>
					</button>
				</div>
				<form
					method="POST"
					id="bulk-upload-form"
					class="space-y-4"
					onsubmit="return confirm('Are you sure you want to create these categories?')"
				>
					<input type="hidden" name="action" value="bulk_create" />
					<div class="form-control">
						<label class="label" for="categories">
							<span class="label-text">Comma-separated Categories</span>
							<span class="label-text-alt">Enter category names separated by commas</span>
						</label>
						<textarea
							id="categories"
							name="categories"
							placeholder="e.g., Technology, Programming, Web Development, Design"
							class="textarea textarea-bordered w-full"
							rows="4"
							required
						></textarea>
						<label class="label">
							<span class="label-text-alt">
								Categories will be created with auto-generated slugs. Duplicates will be skipped.
							</span>
						</label>
					</div>
					<div class="card-actions justify-end">
						<button type="submit" class="btn btn-primary">
							<Upload class="size-5" />
							Create Categories
						</button>
					</div>
				</form>
			</div>
		</div>

		<div class="card bg-base-100 shadow">
			<div class="card-body">
				<div class="form-control mb-4">
					<input
						type="text"
						id="search-input"
						placeholder="Search categories by name, slug, or description..."
						class="input input-bordered w-full"
					/>
				</div>
				<div class="overflow-x-auto">
					<table class="table" id="categories-table">
						<thead>
							<tr>
								<th>Name</th>
								<th>Slug</th>
								<th>Description</th>
								<th>Posts</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{categoriesWithCounts.length === 0 ? (
								<tr>
									<td colspan="5" class="text-center py-12">
										<div class="flex flex-col items-center justify-center gap-4">
											<div class="text-base-content/40 text-lg">
												No categories yet
											</div>
											<p class="text-base-content/60 text-sm max-w-md">
												Categories help organize your blog posts into topics. Create your first category to get started!
											</p>
											<a href="/categories/new" class="btn btn-primary mt-2">
												<Plus class="size-5" />
												Create Your First Category
											</a>
										</div>
									</td>
								</tr>
							) : (
								categoriesWithCounts.map((category) => (
									<tr>
										<td class="font-medium">{category.name}</td>
										<td>
											<code class="text-xs">{category.slug}</code>
										</td>
										<td>
											{category.description ? (
												<span class="text-sm">{category.description}</span>
											) : (
												<span class="text-base-content/40">â€”</span>
											)}
										</td>
										<td>
											<span class="badge badge-secondary">{category.writingCount}</span>
										</td>
										<td>
											<div class="flex gap-2">
												<a
													href={`/categories/${category.id}`}
													class="btn btn-sm btn-ghost"
													title="Edit"
												>
													<Edit class="size-4" />
												</a>
												<form method="POST" class="inline">
													<input type="hidden" name="action" value="delete" />
													<input type="hidden" name="categoryId" value={category.id} />
													<button
														type="submit"
														class="btn btn-sm btn-ghost text-error"
														title="Delete"
														onclick="return confirm('Are you sure you want to delete this category?')"
													>
														<Trash2 class="size-4" />
													</button>
												</form>
											</div>
										</td>
									</tr>
								))
							)}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</AdminLayout>

<script>
	const searchInput = document.getElementById("search-input") as HTMLInputElement;
	const table = document.getElementById("categories-table");
	const tableRows = table?.querySelectorAll("tbody tr");

	if (searchInput && tableRows) {
		searchInput.addEventListener("input", () => {
			const searchTerm = searchInput.value.toLowerCase().trim();

			tableRows.forEach((row) => {
				const cells = row.querySelectorAll("td");
				let matches = false;

				// Search in name, slug, and description columns (first 3 columns)
				for (let i = 0; i < Math.min(3, cells.length); i++) {
					const cellText = cells[i]?.textContent?.toLowerCase() || "";
					if (cellText.includes(searchTerm)) {
						matches = true;
						break;
					}
				}

				// Show/hide row based on match
				if (matches || searchTerm === "") {
					(row as HTMLElement).style.display = "";
				} else {
					(row as HTMLElement).style.display = "none";
				}
			});
		});
	}

	// Toggle bulk upload form
	function toggleBulkUpload() {
		const form = document.getElementById("bulk-upload-form");
		const toggleText = document.getElementById("toggle-text");
		if (form && toggleText) {
			const isHidden = form.classList.toggle("hidden");
			toggleText.textContent = isHidden ? "Show" : "Hide";
		}
	}
</script>
