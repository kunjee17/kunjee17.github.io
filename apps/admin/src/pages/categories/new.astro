---
import AdminLayout from "@components/layout/AdminLayout.astro";
import { X as Cancel, Save } from "@lucide/astro";
import {
	checkCategoryNameExists,
	checkCategorySlugExists,
	createCategory,
	generateSlug,
	validateSlugFormat,
} from "../../lib/queries";

if (Astro.request.method === "POST") {
	const formData = await Astro.request.formData();
	const name = (formData.get("name")?.toString() || "").trim();
	const slugInput = formData.get("slug")?.toString()?.trim();
	const slug = slugInput || generateSlug(name);
	const description = formData.get("description")?.toString()?.trim();

	// Validation
	if (!name) {
		return Astro.redirect("/categories/new?error=name_required", 302);
	}

	if (slug && !validateSlugFormat(slug)) {
		return Astro.redirect("/categories/new?error=invalid_slug", 302);
	}

	try {
		// Check for duplicates
		if (await checkCategoryNameExists(name)) {
			return Astro.redirect("/categories/new?error=name_exists", 302);
		}

		if (await checkCategorySlugExists(slug)) {
			return Astro.redirect("/categories/new?error=slug_exists", 302);
		}

		await createCategory({ name, slug, description });
		return Astro.redirect("/categories?created=true", 302);
	} catch (error) {
		console.error("Error creating category:", error);
		// Check if it's a database constraint error
		if (error instanceof Error && error.message.includes("UNIQUE")) {
			if (error.message.includes("name")) {
				return Astro.redirect("/categories/new?error=name_exists", 302);
			}
			if (error.message.includes("slug")) {
				return Astro.redirect("/categories/new?error=slug_exists", 302);
			}
		}
		return Astro.redirect("/categories/new?error=create_failed", 302);
	}
}

const error = Astro.url.searchParams.get("error");
const errorMessages: Record<string, string> = {
	name_required: "Category name is required.",
	name_exists: "A category with this name already exists.",
	slug_exists: "A category with this slug already exists.",
	invalid_slug:
		"Slug format is invalid. Use only lowercase letters, numbers, and hyphens.",
	create_failed: "Error creating category. Please try again.",
};
---

<AdminLayout title="New Category">
	<div class="space-y-6">
		<h1 class="text-3xl font-bold">New Category</h1>

		{error && (
			<div class="alert alert-error">
				<span>{errorMessages[error] || "Error creating category. Please try again."}</span>
			</div>
		)}

		<form method="POST" class="card bg-base-100 shadow">
			<div class="card-body space-y-4">
				<div class="form-control">
					<label class="label" for="name">
						<span class="label-text">Name *</span>
					</label>
					<input
						type="text"
						id="name"
						name="name"
						placeholder="Category name"
						class="input input-bordered w-full"
						required
					/>
				</div>

				<div class="form-control">
					<label class="label" for="slug">
						<span class="label-text">Slug</span>
						<span class="label-text-alt">Auto-generated from name if empty</span>
					</label>
					<input
						type="text"
						id="slug"
						name="slug"
						placeholder="category-slug"
						class="input input-bordered w-full"
					/>
				</div>

				<div class="form-control">
					<label class="label" for="description">
						<span class="label-text">Description</span>
					</label>
					<textarea
						id="description"
						name="description"
						placeholder="Category description"
						class="textarea textarea-bordered w-full"
						rows="3"
					></textarea>
				</div>

				<div class="card-actions justify-end">
					<a href="/categories" class="btn btn-ghost">
						<Cancel class="size-5" />
						Cancel
					</a>
					<button type="submit" class="btn btn-primary">
						<Save class="size-5" />
						Save Category
					</button>
				</div>
			</div>
		</form>
	</div>
</AdminLayout>

<script>
	// Auto-generate slug from name
	function generateSlug(text: string): string {
		return text
			.toLowerCase()
			.trim()
			.replace(/[^\w\s-]/g, "")
			.replace(/[\s_-]+/g, "-")
			.replace(/^-+|-+$/g, "");
	}

	const nameInput = document.getElementById("name") as HTMLInputElement;
	const slugInput = document.getElementById("slug") as HTMLInputElement;
	let lastAutoGeneratedSlug = "";

	if (nameInput && slugInput) {
		// Store initial slug value to detect manual edits
		let slugManuallyEdited = false;
		const originalSlug = slugInput.value;

		nameInput.addEventListener("input", () => {
			if (!slugManuallyEdited) {
				const autoSlug = generateSlug(nameInput.value);
				slugInput.value = autoSlug;
				lastAutoGeneratedSlug = autoSlug;
			}
		});

		slugInput.addEventListener("input", () => {
			// Check if user manually edited the slug
			const currentSlug = slugInput.value;
			if (currentSlug !== lastAutoGeneratedSlug && currentSlug !== originalSlug) {
				slugManuallyEdited = true;
			} else if (currentSlug === "" || currentSlug === generateSlug(nameInput.value)) {
				// Reset if cleared or matches auto-generated value
				slugManuallyEdited = false;
			}
		});
	}
</script>
