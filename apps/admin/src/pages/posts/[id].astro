---
import {
	checkPostSlugExists,
	generateSlug,
	getAllCategories,
	getAllTags,
	getFirstAuthor,
	getPostWithRelations,
	updatePost,
	validateSlugFormat,
} from "../../lib/db";

const { id } = Astro.params;

if (!id) {
	return Astro.redirect("/posts?error=not_found", 302);
}

// Load post data
const post = await getPostWithRelations(id);

if (!post) {
	return Astro.redirect("/posts?error=not_found", 302);
}

// Load form data
const [_tags, _categories, author] = await Promise.all([
	getAllTags(),
	getAllCategories(),
	getFirstAuthor(),
]);

// Helper function to validate URLs
function isValidUrl(urlString: string): boolean {
	try {
		const url = new URL(urlString);
		return url.protocol === "http:" || url.protocol === "https:";
	} catch {
		return false;
	}
}

// Helper function to validate URL path format
function isValidUrlPath(path: string): boolean {
	return /^\/[^\s]*$/.test(path);
}

// Handle form submission
if (Astro.request.method === "POST") {
	const formData = await Astro.request.formData();

	// Parse form data
	const title = (formData.get("title")?.toString() || "").trim();
	const slug =
		(formData.get("slug")?.toString() || "").trim() || generateSlug(title);
	const linkTitle = formData.get("linkTitle")?.toString()?.trim();
	const description = formData.get("description")?.toString()?.trim();
	const summary = formData.get("summary")?.toString()?.trim();
	const content = (formData.get("content")?.toString() || "").trim();

	// Validation
	if (!title) {
		return Astro.redirect(`/posts/${id}?error=title_required`, 302);
	}

	if (!content) {
		return Astro.redirect(`/posts/${id}?error=content_required`, 302);
	}

	if (!validateSlugFormat(slug)) {
		return Astro.redirect(`/posts/${id}?error=invalid_slug`, 302);
	}

	// Dates
	const publishedAtStr = formData.get("publishedAt")?.toString();
	const expiryDateStr = formData.get("expiryDate")?.toString();
	let publishedAt: Date | undefined;
	let expiryDate: Date | undefined;

	if (publishedAtStr) {
		publishedAt = new Date(publishedAtStr);
		if (Number.isNaN(publishedAt.getTime())) {
			return Astro.redirect(`/posts/${id}?error=invalid_published_date`, 302);
		}
	}

	if (expiryDateStr) {
		expiryDate = new Date(expiryDateStr);
		if (Number.isNaN(expiryDate.getTime())) {
			return Astro.redirect(`/posts/${id}?error=invalid_expiry_date`, 302);
		}
	}

	// Status flags
	const draft = formData.get("draft") === "on";
	const featured = formData.get("featured") === "on";

	// Taxonomies
	const tagIds = formData.getAll("tagIds").map((id) => id.toString());
	const categoryIds = formData.getAll("categoryIds").map((id) => id.toString());
	const keywordsStr = formData.get("keywords")?.toString();
	const keywords = keywordsStr
		? keywordsStr
				.split(",")
				.map((k) => k.trim())
				.filter((k) => k.length > 0)
		: undefined;

	// SEO
	const canonicalUrl = formData.get("canonicalUrl")?.toString()?.trim();
	const metaRobots = formData.get("metaRobots")?.toString()?.trim();
	const ogImage = formData.get("ogImage")?.toString()?.trim();
	const ogType = formData.get("ogType")?.toString()?.trim();
	const twitterCard = formData.get("twitterCard")?.toString()?.trim();
	const schemaType = formData.get("schemaType")?.toString()?.trim();
	const sitemapPriorityStr = formData.get("sitemapPriority")?.toString();
	const sitemapChangefreq = formData
		.get("sitemapChangefreq")
		?.toString()
		?.trim();

	// Validate URLs
	if (canonicalUrl && !isValidUrl(canonicalUrl)) {
		return Astro.redirect(`/posts/${id}?error=invalid_canonical_url`, 302);
	}

	if (ogImage && !isValidUrl(ogImage)) {
		return Astro.redirect(`/posts/${id}?error=invalid_og_image_url`, 302);
	}

	// Validate sitemap priority
	let sitemapPriority: number | undefined;
	if (sitemapPriorityStr) {
		sitemapPriority = parseFloat(sitemapPriorityStr);
		if (
			Number.isNaN(sitemapPriority) ||
			sitemapPriority < 0 ||
			sitemapPriority > 1
		) {
			return Astro.redirect(`/posts/${id}?error=invalid_sitemap_priority`, 302);
		}
	}

	// URL management
	const url = formData.get("url")?.toString()?.trim();
	const aliasesStr = formData.get("aliases")?.toString();
	const aliases = aliasesStr
		? aliasesStr
				.split(",")
				.map((a) => a.trim())
				.filter((a) => a.length > 0)
		: undefined;

	if (url && !isValidUrlPath(url)) {
		return Astro.redirect(`/posts/${id}?error=invalid_url`, 302);
	}

	// Template
	const type = formData.get("type")?.toString()?.trim();
	const layout = formData.get("layout")?.toString()?.trim();
	const weightStr = formData.get("weight")?.toString();

	// Author
	const authorId = formData.get("authorId")?.toString() || author?.id;

	try {
		// Check for duplicate slug (if slug changed)
		if (slug !== post.slug && (await checkPostSlugExists(slug, id))) {
			return Astro.redirect(`/posts/${id}?error=slug_exists`, 302);
		}

		// Update post
		await updatePost(id, {
			title,
			slug,
			linkTitle,
			description,
			summary,
			content,
			publishedAt,
			expiryDate,
			draft,
			featured,
			keywords,
			canonicalUrl,
			metaRobots,
			ogImage,
			ogType,
			twitterCard,
			schemaType,
			sitemapPriority,
			sitemapChangefreq,
			aliases,
			url,
			type,
			layout,
			weight: weightStr ? parseInt(weightStr, 10) : undefined,
			authorId,
			tagIds: tagIds.length > 0 ? tagIds : undefined,
			categoryIds: categoryIds.length > 0 ? categoryIds : undefined,
		});

		return Astro.redirect(`/posts/${id}?updated=true`, 302);
	} catch (error) {
		console.error("Error updating post:", error);
		// Check if it's a database constraint error
		if (error instanceof Error && error.message.includes("UNIQUE")) {
			if (error.message.includes("slug")) {
				return Astro.redirect(`/posts/${id}?error=slug_exists`, 302);
			}
		}
		return Astro.redirect(`/posts/${id}?error=update_failed`, 302);
	}
}

// Format dates for datetime-local inputs
function _formatDateTimeLocal(date: Date | null | undefined): string {
	if (!date) return "";
	const d = new Date(date);
	d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
	return d.toISOString().slice(0, 16);
}

const _updated = Astro.url.searchParams.get("updated") === "true";
const _error = Astro.url.searchParams.get("error");
const _created = Astro.url.searchParams.get("created") === "true";
const _errorMessages: Record<string, string> = {
	title_required: "Post title is required.",
	content_required: "Post content is required.",
	slug_exists: "A post with this slug already exists.",
	invalid_slug:
		"Slug format is invalid. Use only lowercase letters, numbers, and hyphens.",
	invalid_canonical_url: "Invalid canonical URL format.",
	invalid_og_image_url: "Invalid Open Graph image URL format.",
	invalid_url: "Invalid URL format. URL must start with / and be a valid path.",
	invalid_published_date: "Invalid published date format.",
	invalid_expiry_date: "Invalid expiry date format.",
	invalid_sitemap_priority: "Sitemap priority must be between 0.0 and 1.0.",
	update_failed: "Failed to update post. Please try again.",
};

// Parse JSON fields
const _keywords = post.keywords
	? typeof post.keywords === "string"
		? JSON.parse(post.keywords)
		: post.keywords
	: [];
const _aliases = post.aliases
	? typeof post.aliases === "string"
		? JSON.parse(post.aliases)
		: post.aliases
	: [];
const _selectedTagIds = post.tags?.map((t) => t.id) || [];
const _selectedCategoryIds = post.categories?.map((c) => c.id) || [];
---

<AdminLayout title={`Edit Post - ${post.title}`}>
	<div class="space-y-6">
		<h1 class="text-3xl font-bold">Edit Post</h1>

		{created && (
			<div class="alert alert-success">
				<span>Post created successfully!</span>
			</div>
		)}

		{updated && (
			<div class="alert alert-success">
				<span>Post updated successfully!</span>
			</div>
		)}

		{error && (
			<div class="alert alert-error">
				<span>{errorMessages[error] || `Error: ${error}`}</span>
			</div>
		)}

		<form method="POST" class="space-y-6">
			{/* Basic Information */}
			<div class="card bg-base-100 shadow">
				<div class="card-body">
					<h2 class="card-title">Basic Information</h2>
					<div class="space-y-4">
						<div class="form-control">
							<label class="label" for="title">
								<span class="label-text">Title *</span>
							</label>
							<input
								type="text"
								id="title"
								name="title"
								value={post.title}
								class="input input-bordered w-full"
								required
							/>
						</div>

						<div class="form-control">
							<label class="label" for="slug">
								<span class="label-text">Slug</span>
							</label>
							<input
								type="text"
								id="slug"
								name="slug"
								value={post.slug}
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="linkTitle">
								<span class="label-text">Link Title</span>
							</label>
							<input
								type="text"
								id="linkTitle"
								name="linkTitle"
								value={post.linkTitle || ""}
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="description">
								<span class="label-text">Description</span>
							</label>
							<textarea
								id="description"
								name="description"
								class="textarea textarea-bordered w-full"
								rows="2"
							>{post.description || ""}</textarea>
						</div>

						<div class="form-control">
							<label class="label" for="summary">
								<span class="label-text">Summary</span>
							</label>
							<textarea
								id="summary"
								name="summary"
								class="textarea textarea-bordered w-full"
								rows="3"
							>{post.summary || ""}</textarea>
						</div>

						<div class="form-control">
							<label class="label" for="content">
								<span class="label-text">Content *</span>
								<span class="label-text-alt">WYSIWYG Markdown Editor</span>
							</label>
							<MarkdownEditor
								id="content"
								name="content"
								value={post.content}
								required={true}
							/>
						</div>
					</div>
				</div>
			</div>

			{/* Taxonomies */}
			<div class="card bg-base-100 shadow">
				<div class="card-body">
					<h2 class="card-title">Taxonomies</h2>
					<div class="space-y-4">
						<div class="form-control">
							<label class="label" for="tagIds">
								<span class="label-text">Tags</span>
							</label>
							<select
								id="tagIds"
								name="tagIds"
								class="select select-bordered w-full"
								multiple
								size="5"
							>
								{tags.map((tag) => (
									<option value={tag.id} selected={selectedTagIds.includes(tag.id)}>
										{tag.name}
									</option>
								))}
							</select>
							<label class="label">
								<span class="label-text-alt">Hold Ctrl/Cmd to select multiple</span>
							</label>
						</div>

						<div class="form-control">
							<label class="label" for="categoryIds">
								<span class="label-text">Categories</span>
							</label>
							<select
								id="categoryIds"
								name="categoryIds"
								class="select select-bordered w-full"
								multiple
								size="5"
							>
								{categories.map((cat) => (
									<option value={cat.id} selected={selectedCategoryIds.includes(cat.id)}>
										{cat.name}
									</option>
								))}
							</select>
							<label class="label">
								<span class="label-text-alt">Hold Ctrl/Cmd to select multiple</span>
							</label>
						</div>

						<div class="form-control">
							<label class="label" for="keywords">
								<span class="label-text">Keywords</span>
							</label>
							<input
								type="text"
								id="keywords"
								name="keywords"
								value={Array.isArray(keywords) ? keywords.join(", ") : ""}
								class="input input-bordered w-full"
							/>
						</div>
					</div>
				</div>
			</div>

			{/* Author & Dates */}
			<div class="card bg-base-100 shadow">
				<div class="card-body">
					<h2 class="card-title">Author & Dates</h2>
					<div class="space-y-4">
						{author && (
							<div class="form-control">
								<label class="label" for="authorId">
									<span class="label-text">Author</span>
								</label>
								<select id="authorId" name="authorId" class="select select-bordered w-full">
									<option value={author.id} selected={post.authorId === author.id}>
										{author.name}
									</option>
								</select>
							</div>
						)}

						<div class="form-control">
							<label class="label" for="publishedAt">
								<span class="label-text">Published Date</span>
							</label>
							<input
								type="datetime-local"
								id="publishedAt"
								name="publishedAt"
								value={formatDateTimeLocal(post.publishedAt)}
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="expiryDate">
								<span class="label-text">Expiry Date</span>
							</label>
							<input
								type="datetime-local"
								id="expiryDate"
								name="expiryDate"
								value={formatDateTimeLocal(post.expiryDate)}
								class="input input-bordered w-full"
							/>
						</div>

						<div class="text-sm text-base-content/60">
							<div>Created: {format(new Date(post.createdAt), "PPpp")}</div>
							<div>Updated: {format(new Date(post.updatedAt), "PPpp")}</div>
							{post.wordCount && (
								<div>
									Word Count: {post.wordCount} words
									{post.readingTime && ` â€¢ Reading Time: ${post.readingTime} min`}
								</div>
							)}
						</div>
					</div>
				</div>
			</div>

			{/* Status & Flags */}
			<div class="card bg-base-100 shadow">
				<div class="card-body">
					<h2 class="card-title">Status & Flags</h2>
					<div class="space-y-4">
						<div class="form-control">
							<label class="label cursor-pointer">
								<span class="label-text">Draft</span>
								<input
									type="checkbox"
									name="draft"
									class="checkbox checkbox-primary"
									checked={post.draft}
								/>
							</label>
						</div>

						<div class="form-control">
							<label class="label cursor-pointer">
								<span class="label-text">Featured</span>
								<input
									type="checkbox"
									name="featured"
									class="checkbox checkbox-primary"
									checked={post.featured}
								/>
							</label>
						</div>

						<div class="form-control">
							<label class="label" for="weight">
								<span class="label-text">Weight</span>
							</label>
							<input
								type="number"
								id="weight"
								name="weight"
								value={post.weight || ""}
								class="input input-bordered w-full"
							/>
						</div>
					</div>
				</div>
			</div>

			{/* SEO Metadata */}
			<div class="collapse collapse-arrow bg-base-100 shadow">
				<input type="checkbox" />
				<div class="collapse-title text-xl font-medium">SEO Metadata</div>
				<div class="collapse-content">
					<div class="space-y-4 pt-4">
						<div class="form-control">
							<label class="label" for="canonicalUrl">
								<span class="label-text">Canonical URL</span>
							</label>
							<input
								type="url"
								id="canonicalUrl"
								name="canonicalUrl"
								value={post.canonicalUrl || ""}
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="metaRobots">
								<span class="label-text">Meta Robots</span>
							</label>
							<select id="metaRobots" name="metaRobots" class="select select-bordered w-full">
								<option value="">Default (index, follow)</option>
								<option value="index, follow" selected={post.metaRobots === "index, follow"}>
									index, follow
								</option>
								<option value="noindex, follow" selected={post.metaRobots === "noindex, follow"}>
									noindex, follow
								</option>
								<option value="index, nofollow" selected={post.metaRobots === "index, nofollow"}>
									index, nofollow
								</option>
								<option
									value="noindex, nofollow"
									selected={post.metaRobots === "noindex, nofollow"}
								>
									noindex, nofollow
								</option>
							</select>
						</div>

						<div class="form-control">
							<label class="label" for="ogImage">
								<span class="label-text">Open Graph Image URL</span>
							</label>
							<input
								type="url"
								id="ogImage"
								name="ogImage"
								value={post.ogImage || ""}
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="ogType">
								<span class="label-text">Open Graph Type</span>
							</label>
							<select id="ogType" name="ogType" class="select select-bordered w-full">
								<option value="">Default</option>
								<option value="article" selected={post.ogType === "article"}>
									article
								</option>
								<option value="website" selected={post.ogType === "website"}>
									website
								</option>
							</select>
						</div>

						<div class="form-control">
							<label class="label" for="twitterCard">
								<span class="label-text">Twitter Card Type</span>
							</label>
							<select id="twitterCard" name="twitterCard" class="select select-bordered w-full">
								<option value="">Default</option>
								<option value="summary" selected={post.twitterCard === "summary"}>
									summary
								</option>
								<option
									value="summary_large_image"
									selected={post.twitterCard === "summary_large_image"}
								>
									summary_large_image
								</option>
							</select>
						</div>

						<div class="form-control">
							<label class="label" for="schemaType">
								<span class="label-text">Schema.org Type</span>
							</label>
							<select id="schemaType" name="schemaType" class="select select-bordered w-full">
								<option value="">None</option>
								<option value="Article" selected={post.schemaType === "Article"}>
									Article
								</option>
								<option value="BlogPosting" selected={post.schemaType === "BlogPosting"}>
									BlogPosting
								</option>
								<option value="FAQPage" selected={post.schemaType === "FAQPage"}>
									FAQPage
								</option>
							</select>
						</div>

						<div class="form-control">
							<label class="label" for="sitemapPriority">
								<span class="label-text">Sitemap Priority</span>
								<span class="label-text-alt">0.0 to 1.0</span>
							</label>
							<input
								type="range"
								id="sitemapPriority"
								name="sitemapPriority"
								min="0"
								max="1"
								step="0.1"
								value={post.sitemapPriority || 0.5}
								class="range range-primary"
							/>
							<div class="w-full flex justify-between text-xs px-2">
								<span>0.0</span>
								<span>0.5</span>
								<span>1.0</span>
							</div>
						</div>

						<div class="form-control">
							<label class="label" for="sitemapChangefreq">
								<span class="label-text">Sitemap Change Frequency</span>
							</label>
							<select
								id="sitemapChangefreq"
								name="sitemapChangefreq"
								class="select select-bordered w-full"
							>
								<option value="">Default</option>
								<option value="always" selected={post.sitemapChangefreq === "always"}>
									always
								</option>
								<option value="hourly" selected={post.sitemapChangefreq === "hourly"}>
									hourly
								</option>
								<option value="daily" selected={post.sitemapChangefreq === "daily"}>
									daily
								</option>
								<option value="weekly" selected={post.sitemapChangefreq === "weekly"}>
									weekly
								</option>
								<option value="monthly" selected={post.sitemapChangefreq === "monthly"}>
									monthly
								</option>
								<option value="yearly" selected={post.sitemapChangefreq === "yearly"}>
									yearly
								</option>
								<option value="never" selected={post.sitemapChangefreq === "never"}>
									never
								</option>
							</select>
						</div>
					</div>
				</div>
			</div>

			{/* URL Management */}
			<div class="card bg-base-100 shadow">
				<div class="card-body">
					<h2 class="card-title">URL Management</h2>
					<div class="space-y-4">
						<div class="form-control">
							<label class="label" for="url">
								<span class="label-text">Custom URL Override</span>
							</label>
							<input
								type="text"
								id="url"
								name="url"
								value={post.url || ""}
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="aliases">
								<span class="label-text">Aliases</span>
							</label>
							<input
								type="text"
								id="aliases"
								name="aliases"
								value={Array.isArray(aliases) ? aliases.join(", ") : ""}
								class="input input-bordered w-full"
							/>
						</div>
					</div>
				</div>
			</div>

			{/* Template Selection */}
			<div class="card bg-base-100 shadow">
				<div class="card-body">
					<h2 class="card-title">Template Selection</h2>
					<div class="space-y-4">
						<div class="form-control">
							<label class="label" for="type">
								<span class="label-text">Type</span>
							</label>
							<input
								type="text"
								id="type"
								name="type"
								value={post.type || ""}
								class="input input-bordered w-full"
							/>
						</div>

						<div class="form-control">
							<label class="label" for="layout">
								<span class="label-text">Layout</span>
							</label>
							<input
								type="text"
								id="layout"
								name="layout"
								value={post.layout || ""}
								class="input input-bordered w-full"
							/>
						</div>
					</div>
				</div>
			</div>

			<div class="card-actions justify-end">
				<a href="/posts" class="btn btn-ghost">
					<Cancel class="size-5" />
					Cancel
				</a>
				<button type="submit" class="btn btn-primary">
					<Save class="size-5" />
					Update Post
				</button>
			</div>
		</form>
	</div>
</AdminLayout>

<script>
	// Auto-generate slug from title
	function generateSlug(text: string): string {
		return text
			.toLowerCase()
			.trim()
			.replace(/[^\w\s-]/g, "")
			.replace(/[\s_-]+/g, "-")
			.replace(/^-+|-+$/g, "");
	}

	const titleInput = document.getElementById("title") as HTMLInputElement;
	const slugInput = document.getElementById("slug") as HTMLInputElement;

	if (titleInput && slugInput) {
		// Store initial slug value to detect manual edits
		let slugManuallyEdited = false;
		const originalSlug = slugInput.value;
		let lastAutoGeneratedSlug = originalSlug;

		titleInput.addEventListener("input", () => {
			if (!slugManuallyEdited) {
				const autoSlug = generateSlug(titleInput.value);
				slugInput.value = autoSlug;
				lastAutoGeneratedSlug = autoSlug;
			}
		});

		slugInput.addEventListener("input", () => {
			// Check if user manually edited the slug
			const currentSlug = slugInput.value;
			if (currentSlug !== lastAutoGeneratedSlug && currentSlug !== originalSlug) {
				slugManuallyEdited = true;
			} else if (currentSlug === "" || currentSlug === generateSlug(titleInput.value)) {
				// Reset if cleared or matches auto-generated value
				slugManuallyEdited = false;
			}
		});
	}
</script>
