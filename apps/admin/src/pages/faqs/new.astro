---
import { createFAQ, getAllPages, getAllPosts } from "../../lib/db";

if (Astro.request.method === "POST") {
	const formData = await Astro.request.formData();
	const question = formData.get("question")?.toString() || "";
	const answer = formData.get("answer")?.toString() || "";
	const blogPostId = formData.get("blogPostId")?.toString();
	const pageId = formData.get("pageId")?.toString();
	const orderStr = formData.get("order")?.toString();

	try {
		await createFAQ({
			question,
			answer,
			blogPostId: blogPostId || undefined,
			pageId: pageId || undefined,
			order: orderStr ? parseInt(orderStr, 10) : undefined,
		});
		return Astro.redirect("/faqs?created=true", 302);
	} catch (error) {
		console.error("Error creating FAQ:", error);
		return Astro.redirect("/faqs/new?error=create_failed", 302);
	}
}

const [_posts, _pages] = await Promise.all([getAllPosts(), getAllPages()]);
const _error = Astro.url.searchParams.get("error");
---

<AdminLayout title="New FAQ">
	<div class="space-y-6">
		<h1 class="text-3xl font-bold">New FAQ</h1>

		{error && (
			<div class="alert alert-error">
				<span>Error creating FAQ. Please try again.</span>
			</div>
		)}

		<form method="POST" class="card bg-base-100 shadow">
			<div class="card-body space-y-4">
				<div class="form-control">
					<label class="label" for="question">
						<span class="label-text">Question *</span>
					</label>
					<input
						type="text"
						id="question"
						name="question"
						placeholder="What is...?"
						class="input input-bordered w-full"
						required
					/>
				</div>

				<div class="form-control">
					<label class="label" for="answer">
						<span class="label-text">Answer *</span>
					</label>
					<textarea
						id="answer"
						name="answer"
						placeholder="Answer to the question"
						class="textarea textarea-bordered w-full"
						rows="4"
						required
					></textarea>
				</div>

				<div class="form-control">
					<label class="label" for="blogPostId">
						<span class="label-text">Associated Post</span>
						<span class="label-text-alt">Optional - link to a post</span>
					</label>
					<select id="blogPostId" name="blogPostId" class="select select-bordered w-full">
						<option value="">None</option>
						{posts.map((post) => (
							<option value={post.id}>{post.title}</option>
						))}
					</select>
				</div>

				<div class="form-control">
					<label class="label" for="pageId">
						<span class="label-text">Associated Page</span>
						<span class="label-text-alt">Optional - link to a page</span>
					</label>
					<select id="pageId" name="pageId" class="select select-bordered w-full">
						<option value="">None</option>
						{pages.map((page) => (
							<option value={page.id}>{page.title}</option>
						))}
					</select>
				</div>

				<div class="form-control">
					<label class="label" for="order">
						<span class="label-text">Order</span>
						<span class="label-text-alt">Display order (lower = first)</span>
					</label>
					<input
						type="number"
						id="order"
						name="order"
						placeholder="0"
						class="input input-bordered w-full"
					/>
				</div>

				<div class="card-actions justify-end">
					<a href="/faqs" class="btn btn-ghost">
						<Cancel class="size-5" />
						Cancel
					</a>
					<button type="submit" class="btn btn-primary">
						<Save class="size-5" />
						Save FAQ
					</button>
				</div>
			</div>
		</form>
	</div>
</AdminLayout>
